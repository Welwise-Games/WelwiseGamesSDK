(function() {
    console.log('[PLAYGAMMA_ADAPTER] PlayGamma adapter loading...');

    window.__sdk_adapter = {
        GetModules: function() {
            return [
                "Advertisement",
                "Environment", 
                "PlayerData",
                "Analytics",
                "Payments",
                "PlatformNavigation",
                "GameData"
            ];
        },
        
        Init: function() {
            console.log('[PLAYGAMMA_ADAPTER] Starting initialization...');
            
            // Если SDK уже инициализирован
            if (window.bridge && window.bridge.isInitialized) {
                console.log('[PLAYGAMMA_ADAPTER] SDK already initialized');
                if (window.unityInstance) {
                    window.unityInstance.SendMessage('PluginRuntime', 'HandleInitSuccess', '');
                }
                return;
            }

            // Загружаем PlayGamma SDK если еще не загружен
            if (!document.querySelector('script[src*="playgama-bridge"]')) {
                const script = document.createElement('script');
                script.src = 'https://bridge.playgama.com/v1/stable/playgama-bridge.js';
                script.async = true;
                script.onload = function() {
                    console.log('[PLAYGAMMA_ADAPTER] PlayGamma SDK script loaded successfully');
                    initializeBridge();
                };
                script.onerror = function(error) {
                    console.error('[PLAYGAMMA_ADAPTER] Failed to load PlayGamma SDK:', error);
                    if (window.unityInstance) {
                        window.unityInstance.SendMessage('PluginRuntime', 'HandleInitError', 'Failed to load PlayGamma SDK');
                    }
                };
                document.head.appendChild(script);
            } else {
                console.log('[PLAYGAMMA_ADAPTER] PlayGamma SDK already loaded, initializing...');
                initializeBridge();
            }

            function initializeBridge() {
                if (!window.bridge || typeof window.bridge.initialize !== 'function') {
                    console.error('[PLAYGAMMA_ADAPTER] PlayGamma bridge not available');
                    if (window.unityInstance) {
                        window.unityInstance.SendMessage('PluginRuntime', 'HandleInitError', 'PlayGamma bridge not available');
                    }
                    return;
                }

                window.bridge.initialize()
                    .then(() => {
                        console.log('[PLAYGAMMA_ADAPTER] SDK initialized successfully');
                        
                        // Подписываемся на события рекламы
                        if (window.bridge.advertisement) {
                            window.bridge.advertisement.on(
                                window.bridge.EVENT_NAME.INTERSTITIAL_STATE_CHANGED, 
                                handleInterstitialStateChange
                            );
                            window.bridge.advertisement.on(
                                window.bridge.EVENT_NAME.REWARDED_STATE_CHANGED, 
                                handleRewardedStateChange
                            );
                        }

                        // Подписываемся на события платформы
                        if (window.bridge.platform) {
                            window.bridge.platform.on(
                                window.bridge.EVENT_NAME.AUDIO_STATE_CHANGED,
                                handleAudioStateChange
                            );
                            window.bridge.platform.on(
                                window.bridge.EVENT_NAME.PAUSE_STATE_CHANGED,
                                handlePauseStateChange
                            );
                        }

                        // Подписываемся на события игры
                        if (window.bridge.game) {
                            window.bridge.game.on(
                                window.bridge.EVENT_NAME.VISIBILITY_STATE_CHANGED,
                                handleVisibilityStateChange
                            );
                        }

                        if (window.unityInstance) {
                            window.unityInstance.SendMessage('PluginRuntime', 'HandleInitSuccess', '');
                        }
                    })
                    .catch(error => {
                        console.error('[PLAYGAMMA_ADAPTER] SDK initialization failed:', error);
                        if (window.unityInstance) {
                            window.unityInstance.SendMessage(
                                'PluginRuntime', 
                                'HandleInitError', 
                                error.message || String(error)
                            );
                        }
                    });
            }

            function handleInterstitialStateChange(state) {
                console.log('[PLAYGAMMA_ADAPTER] Interstitial state changed:', state);
                switch (state) {
                    case 'opened':
                        if (window.unityInstance) {
                            window.unityInstance.SendMessage('PluginRuntime', 'HandleInterstitialOpen', '');
                        }
                        break;
                    case 'closed':
                        if (window.unityInstance) {
                            window.unityInstance.SendMessage('PluginRuntime', 'HandleInterstitialClose', '');
                        }
                        break;
                    case 'failed':
                        if (window.unityInstance) {
                            window.unityInstance.SendMessage('PluginRuntime', 'HandleInterstitialError', 'Interstitial ad failed');
                        }
                        break;
                }
            }

            function handleRewardedStateChange(state) {
                console.log('[PLAYGAMMA_ADAPTER] Rewarded state changed:', state);
                switch (state) {
                    case 'opened':
                        if (window.unityInstance) {
                            window.unityInstance.SendMessage('PluginRuntime', 'HandleRewardedOpen', '');
                        }
                        break;
                    case 'rewarded':
                        if (window.unityInstance) {
                            window.unityInstance.SendMessage('PluginRuntime', 'HandleRewardedRewarded', '');
                        }
                        break;
                    case 'closed':
                        if (window.unityInstance) {
                            window.unityInstance.SendMessage('PluginRuntime', 'HandleRewardedClose', '');
                        }
                        break;
                    case 'failed':
                        if (window.unityInstance) {
                            window.unityInstance.SendMessage('PluginRuntime', 'HandleRewardedError', 'Rewarded ad failed');
                        }
                        break;
                }
            }

            function handleAudioStateChange(isEnabled) {
                console.log('[PLAYGAMMA_ADAPTER] Audio state changed:', isEnabled);
                if (window.unityInstance) {
                    window.unityInstance.SendMessage(
                        'PluginRuntime',
                        'HandleAudioStateChange',
                        isEnabled ? 'true' : 'false'
                    );
                }
            }

            function handlePauseStateChange(isPaused) {
                console.log('[PLAYGAMMA_ADAPTER] Pause state changed:', isPaused);
                if (window.unityInstance) {
                    window.unityInstance.SendMessage(
                        'PluginRuntime',
                        'HandlePauseStateChange',
                        isPaused ? 'true' : 'false'
                    );
                }
            }

            function handleVisibilityStateChange(state) {
                console.log('[PLAYGAMMA_ADAPTER] Visibility state changed:', state);
                if (window.unityInstance) {
                    window.unityInstance.SendMessage(
                        'PluginRuntime',
                        'HandleVisibilityStateChange',
                        state
                    );
                }
            }

            // Таймаут для инициализации
            setTimeout(() => {
                if (!window.bridge || !window.bridge.isInitialized) {
                    console.error('[PLAYGAMMA_ADAPTER] SDK initialization timeout');
                    if (window.unityInstance) {
                        window.unityInstance.SendMessage('PluginRuntime', 'HandleInitError', 'SDK initialization timeout');
                    }
                }
            }, 15000);
        },

        // Environment methods
        GetPlayerId: function() {
            console.log('[PLAYGAMMA_ADAPTER] Getting player ID');
            
            if (!window.bridge) {
                if (window.unityInstance) {
                    window.unityInstance.SendMessage('PluginRuntime', 'HandleGetPlayerIdError', 'SDK not initialized');
                }
                return;
            }

            try {
                let playerId = '';
                if (window.bridge.user && window.bridge.user.id) {
                    playerId = window.bridge.user.id;
                } else if (window.bridge.player && window.bridge.player.id) {
                    playerId = window.bridge.player.id;
                }
                
                if (window.unityInstance) {
                    window.unityInstance.SendMessage('PluginRuntime', 'HandleGetPlayerIdSuccess', playerId);
                }
            } catch (error) {
                if (window.unityInstance) {
                    window.unityInstance.SendMessage(
                        'PluginRuntime',
                        'HandleGetPlayerIdError',
                        error.message || String(error)
                    );
                }
            }
        },

        GetDeviceType: function() {
            console.log('[PLAYGAMMA_ADAPTER] Getting device type');
            let deviceType = 'desktop';
            const ua = navigator.userAgent;
            
            if (/iPhone|iPad|iPod/i.test(ua)) {
                deviceType = 'mobile';
            } else if (/Android/i.test(ua)) {
                deviceType = 'mobile';
            } else if (/Tablet|iPad/i.test(ua)) {
                deviceType = 'tablet';
            }
            
            if (window.unityInstance) {
                window.unityInstance.SendMessage('PluginRuntime', 'HandleGetDeviceTypeSuccess', deviceType);
            }
        },

        GetLanguageCode: function() {
            console.log('[PLAYGAMMA_ADAPTER] Getting language code');
            
            if (!window.bridge) {
                const lang = (navigator.language || navigator.userLanguage || 'en').split('-')[0];
                if (window.unityInstance) {
                    window.unityInstance.SendMessage('PluginRuntime', 'HandleGetLanguageCodeSuccess', lang);
                }
                return;
            }

            try {
                const lang = window.bridge.platform.language || 
                            (navigator.language || navigator.userLanguage || 'en').split('-')[0];
                if (window.unityInstance) {
                    window.unityInstance.SendMessage('PluginRuntime', 'HandleGetLanguageCodeSuccess', lang);
                }
            } catch (error) {
                const lang = (navigator.language || navigator.userLanguage || 'en').split('-')[0];
                if (window.unityInstance) {
                    window.unityInstance.SendMessage('PluginRuntime', 'HandleGetLanguageCodeSuccess', lang);
                }
            }
        },

        GetServerTime: function() {
            console.log('[PLAYGAMMA_ADAPTER] Getting server time');
            
            if (!window.bridge) {
                const timestamp = Math.floor(Date.now() / 1000);
                if (window.unityInstance) {
                    window.unityInstance.SendMessage('PluginRuntime', 'HandleGetTimeSuccess', String(timestamp));
                }
                return;
            }

            window.bridge.platform.getServerTime()
                .then(time => {
                    const timestamp = Math.floor(time / 1000);
                    if (window.unityInstance) {
                        window.unityInstance.SendMessage('PluginRuntime', 'HandleGetTimeSuccess', String(timestamp));
                    }
                })
                .catch(error => {
                    console.error('[PLAYGAMMA_ADAPTER] Failed to get server time:', error);
                    const timestamp = Math.floor(Date.now() / 1000);
                    if (window.unityInstance) {
                        window.unityInstance.SendMessage('PluginRuntime', 'HandleGetTimeSuccess', String(timestamp));
                    }
                });
        },

        GetPlatformId: function() {
            console.log('[PLAYGAMMA_ADAPTER] Getting platform ID');
            
            if (!window.bridge) {
                if (window.unityInstance) {
                    window.unityInstance.SendMessage('PluginRuntime', 'HandleGetPlatformIdError', 'SDK not initialized');
                }
                return;
            }

            try {
                const platformId = window.bridge.platform.id || 'playgama';
                if (window.unityInstance) {
                    window.unityInstance.SendMessage('PluginRuntime', 'HandleGetPlatformIdSuccess', platformId);
                }
            } catch (error) {
                if (window.unityInstance) {
                    window.unityInstance.SendMessage(
                        'PluginRuntime',
                        'HandleGetPlatformIdError',
                        error.message || String(error)
                    );
                }
            }
        },

        GetPayload: function() {
            console.log('[PLAYGAMMA_ADAPTER] Getting payload');
            
            if (!window.bridge) {
                if (window.unityInstance) {
                    window.unityInstance.SendMessage('PluginRuntime', 'HandleGetPayloadError', 'SDK not initialized');
                }
                return;
            }

            try {
                const payload = window.bridge.platform.payload || '';
                if (window.unityInstance) {
                    window.unityInstance.SendMessage('PluginRuntime', 'HandleGetPayloadSuccess', payload);
                }
            } catch (error) {
                if (window.unityInstance) {
                    window.unityInstance.SendMessage(
                        'PluginRuntime',
                        'HandleGetPayloadError',
                        error.message || String(error)
                    );
                }
            }
        },

        GetTLD: function() {
            console.log('[PLAYGAMMA_ADAPTER] Getting TLD');
            
            if (!window.bridge) {
                if (window.unityInstance) {
                    window.unityInstance.SendMessage('PluginRuntime', 'HandleGetTLDError', 'SDK not initialized');
                }
                return;
            }

            try {
                const tld = window.bridge.platform.tld || '';
                if (window.unityInstance) {
                    window.unityInstance.SendMessage('PluginRuntime', 'HandleGetTLDSuccess', tld);
                }
            } catch (error) {
                if (window.unityInstance) {
                    window.unityInstance.SendMessage(
                        'PluginRuntime',
                        'HandleGetTLDError',
                        error.message || String(error)
                    );
                }
            }
        },

        IsAudioEnabled: function() {
            console.log('[PLAYGAMMA_ADAPTER] Checking audio state');
            
            if (!window.bridge) {
                if (window.unityInstance) {
                    window.unityInstance.SendMessage('PluginRuntime', 'HandleIsAudioEnabledError', 'SDK not initialized');
                }
                return;
            }

            try {
                const isEnabled = window.bridge.platform.isAudioEnabled;
                if (window.unityInstance) {
                    window.unityInstance.SendMessage(
                        'PluginRuntime',
                        'HandleIsAudioEnabledSuccess',
                        isEnabled ? 'true' : 'false'
                    );
                }
            } catch (error) {
                if (window.unityInstance) {
                    window.unityInstance.SendMessage(
                        'PluginRuntime',
                        'HandleIsAudioEnabledError',
                        error.message || String(error)
                    );
                }
            }
        },

        GetVisibilityState: function() {
            console.log('[PLAYGAMMA_ADAPTER] Getting visibility state');
            
            if (!window.bridge) {
                if (window.unityInstance) {
                    window.unityInstance.SendMessage('PluginRuntime', 'HandleGetVisibilityStateError', 'SDK not initialized');
                }
                return;
            }

            try {
                const state = window.bridge.game.visibilityState || 'visible';
                if (window.unityInstance) {
                    window.unityInstance.SendMessage('PluginRuntime', 'HandleGetVisibilityStateSuccess', state);
                }
            } catch (error) {
                if (window.unityInstance) {
                    window.unityInstance.SendMessage(
                        'PluginRuntime',
                        'HandleGetVisibilityStateError',
                        error.message || String(error)
                    );
                }
            }
        },

        // PlayerData methods
        GetPlayerData: function() {
            console.log('[PLAYGAMMA_ADAPTER] Getting player data');
            
            if (!window.bridge || !window.bridge.storage) {
                if (window.unityInstance) {
                    window.unityInstance.SendMessage('PluginRuntime', 'HandleGetDataError', 'SDK not initialized');
                }
                return;
            }

            const storageKey = 'unity_game_data';
            
            window.bridge.storage.get(storageKey)
                .then(data => {
                    try {
                        let universalData = {
                            playerName: '',
                            playerGameData: []
                        };

                        if (data) {
                            const savedData = typeof data === 'string' ? JSON.parse(data) : data;
                            universalData.playerName = savedData.playerName || '';
                            universalData.playerGameData = savedData.playerGameData || [];
                        }

                        if (window.unityInstance) {
                            window.unityInstance.SendMessage(
                                'PluginRuntime', 
                                'HandleGetDataSuccess', 
                                JSON.stringify(universalData)
                            );
                        }
                    } catch (e) {
                        console.error('[PLAYGAMMA_ADAPTER] Data parse error:', e);
                        if (window.unityInstance) {
                            window.unityInstance.SendMessage(
                                'PluginRuntime',
                                'HandleGetDataError',
                                'Data parse error: ' + e.message
                            );
                        }
                    }
                })
                .catch(error => {
                    console.error('[PLAYGAMMA_ADAPTER] Get player data error:', error);
                    if (window.unityInstance) {
                        window.unityInstance.SendMessage(
                            'PluginRuntime',
                            'HandleGetDataError',
                            error.message || String(error)
                        );
                    }
                });
        },

        SetPlayerData: function(jsonData) {
            console.log('[PLAYGAMMA_ADAPTER] Setting player data');
            
            if (!window.bridge || !window.bridge.storage) {
                if (window.unityInstance) {
                    window.unityInstance.SendMessage('PluginRuntime', 'HandleSetDataError', 'SDK not initialized');
                }
                return;
            }

            try {
                const universalData = JSON.parse(jsonData);
                const storageKey = 'unity_game_data';
                
                window.bridge.storage.set(storageKey, JSON.stringify(universalData))
                    .then(() => {
                        if (window.unityInstance) {
                            window.unityInstance.SendMessage('PluginRuntime', 'HandleSetDataSuccess', '');
                        }
                    })
                    .catch(error => {
                        console.error('[PLAYGAMMA_ADAPTER] Set player data error:', error);
                        if (window.unityInstance) {
                            window.unityInstance.SendMessage(
                                'PluginRuntime',
                                'HandleSetDataError',
                                error.message || String(error)
                            );
                        }
                    });

            } catch (e) {
                console.error('[PLAYGAMMA_ADAPTER] JSON parse error:', e);
                if (window.unityInstance) {
                    window.unityInstance.SendMessage('PluginRuntime', 'HandleSetDataError', 'Invalid JSON format');
                }
            }
        },

        DeletePlayerData: function(key) {
            console.log('[PLAYGAMMA_ADAPTER] Deleting player data for key:', key);
            
            if (!window.bridge || !window.bridge.storage) {
                if (window.unityInstance) {
                    window.unityInstance.SendMessage('PluginRuntime', 'HandleDeleteDataError', 'SDK not initialized');
                }
                return;
            }

            window.bridge.storage.delete(key)
                .then(() => {
                    if (window.unityInstance) {
                        window.unityInstance.SendMessage('PluginRuntime', 'HandleDeleteDataSuccess', '');
                    }
                })
                .catch(error => {
                    console.error('[PLAYGAMMA_ADAPTER] Delete player data error:', error);
                    if (window.unityInstance) {
                        window.unityInstance.SendMessage(
                            'PluginRuntime',
                            'HandleDeleteDataError',
                            error.message || String(error)
                        );
                    }
                });
        },

        // Analytics methods
        GameReady: function() {
            console.log('[PLAYGAMMA_ADAPTER] Game ready');
            
            if (window.bridge && window.bridge.platform) {
                window.bridge.platform.sendMessage('game_ready');
            }
            
            if (window.unityInstance) {
                window.unityInstance.SendMessage('PluginRuntime', 'HandleGameReadySuccess', '');
            }
        },

        GameplayStart: function() {
            console.log('[PLAYGAMMA_ADAPTER] Gameplay start');
            
            if (window.bridge && window.bridge.platform) {
                window.bridge.platform.sendMessage('gameplay_started');
            }
            
            if (window.unityInstance) {
                window.unityInstance.SendMessage('PluginRuntime', 'HandleGameplayStartSuccess', '');
            }
        },

        GameplayStop: function() {
            console.log('[PLAYGAMMA_ADAPTER] Gameplay stop');
            
            if (window.bridge && window.bridge.platform) {
                window.bridge.platform.sendMessage('gameplay_stopped');
            }
            
            if (window.unityInstance) {
                window.unityInstance.SendMessage('PluginRuntime', 'HandleGameplayStopSuccess', '');
            }
        },

        InGameLoadingStart: function() {
            console.log('[PLAYGAMMA_ADAPTER] In-game loading start');
            
            if (window.bridge && window.bridge.platform) {
                window.bridge.platform.sendMessage('in_game_loading_started');
            }
            
            if (window.unityInstance) {
                window.unityInstance.SendMessage('PluginRuntime', 'HandleInGameLoadingStartSuccess', '');
            }
        },

        InGameLoadingStop: function() {
            console.log('[PLAYGAMMA_ADAPTER] In-game loading stop');
            
            if (window.bridge && window.bridge.platform) {
                window.bridge.platform.sendMessage('in_game_loading_stopped');
            }
            
            if (window.unityInstance) {
                window.unityInstance.SendMessage('PluginRuntime', 'HandleInGameLoadingStopSuccess', '');
            }
        },

        SendEvent: function(eventName, data) {
            console.log('[PLAYGAMMA_ADAPTER] Sending analytics event:', eventName);
            
            if (!window.bridge) {
                console.warn('[PLAYGAMMA_ADAPTER] SDK not initialized');
                return;
            }

            try {
                if (window.bridge.platform) {
                    if (eventName === 'achievement_unlocked') {
                        window.bridge.platform.sendMessage('player_got_achievement');
                    } else {
                        console.log('[PLAYGAMMA_ADAPTER] Analytics event:', eventName, data);
                    }
                }
            } catch (e) {
                console.error('[PLAYGAMMA_ADAPTER] Analytics error:', e);
            }
        },

        // Advertisement methods
        ShowInterstitial: function() {
            console.log('[PLAYGAMMA_ADAPTER] Showing interstitial ad');
            
            if (!window.bridge || !window.bridge.advertisement) {
                console.error('[PLAYGAMMA_ADAPTER] Ad system not available');
                if (window.unityInstance) {
                    window.unityInstance.SendMessage('PluginRuntime', 'HandleInterstitialError', 'Ad system not loaded');
                }
                return;
            }

            if (!window.bridge.advertisement.isInterstitialSupported) {
                console.error('[PLAYGAMMA_ADAPTER] Interstitial ads not supported');
                if (window.unityInstance) {
                    window.unityInstance.SendMessage('PluginRuntime', 'HandleInterstitialError', 'Interstitial ads not supported');
                }
                return;
            }

            try {
                window.bridge.advertisement.showInterstitial('game_interstitial');
            } catch (e) {
                console.error('[PLAYGAMMA_ADAPTER] Interstitial error:', e);
                if (window.unityInstance) {
                    window.unityInstance.SendMessage(
                        'PluginRuntime',
                        'HandleInterstitialError',
                        e.message || String(e)
                    );
                }
            }
        },

        ShowRewarded: function() {
            console.log('[PLAYGAMMA_ADAPTER] Showing rewarded ad');
            
            if (!window.bridge || !window.bridge.advertisement) {
                console.error('[PLAYGAMMA_ADAPTER] Rewarded ad system not available');
                if (window.unityInstance) {
                    window.unityInstance.SendMessage('PluginRuntime', 'HandleRewardedError', 'Rewarded ad system not loaded');
                }
                return;
            }

            if (!window.bridge.advertisement.isRewardedSupported) {
                console.error('[PLAYGAMMA_ADAPTER] Rewarded ads not supported');
                if (window.unityInstance) {
                    window.unityInstance.SendMessage('PluginRuntime', 'HandleRewardedError', 'Rewarded ads not supported');
                }
                return;
            }

            try {
                window.bridge.advertisement.showRewarded('game_rewarded');
            } catch (e) {
                console.error('[PLAYGAMMA_ADAPTER] Rewarded ad error:', e);
                if (window.unityInstance) {
                    window.unityInstance.SendMessage(
                        'PluginRuntime',
                        'HandleRewardedError',
                        e.message || String(e)
                    );
                }
            }
        },

        // Payments methods
        PaymentsInit: function() {
            console.log('[PLAYGAMMA_ADAPTER] Initializing payments');
            
            if (!window.bridge) {
                if (window.unityInstance) {
                    window.unityInstance.SendMessage('PluginRuntime', 'HandlePaymentsInitError', 'SDK not initialized');
                }
                return;
            }

            if (!window.bridge.payments) {
                if (window.unityInstance) {
                    window.unityInstance.SendMessage('PluginRuntime', 'HandlePaymentsInitError', 'Payments not supported');
                }
                return;
            }

            if (window.bridge.payments.isSupported) {
                if (window.unityInstance) {
                    window.unityInstance.SendMessage('PluginRuntime', 'HandlePaymentsInitSuccess', '');
                }
            } else {
                if (window.unityInstance) {
                    window.unityInstance.SendMessage('PluginRuntime', 'HandlePaymentsInitError', 'Payments not supported');
                }
            }
        },

        PaymentsGetCatalog: function() {
            console.log('[PLAYGAMMA_ADAPTER] Getting payments catalog');
            
            if (!window.bridge || !window.bridge.payments) {
                if (window.unityInstance) {
                    window.unityInstance.SendMessage('PluginRuntime', 'HandlePaymentsGetCatalogError', 'Payments not initialized');
                }
                return;
            }

            window.bridge.payments.getCatalog()
                .then(products => {
                    const catalog = products.map(product => ({
                        id: product.id,
                        title: product.title || '',
                        description: product.description || '',
                        imageURI: product.imageURI || '',
                        price: product.price || '',
                        priceValue: product.priceValue || 0,
                        priceCurrencyCode: product.priceCurrencyCode || ''
                    }));

                    if (window.unityInstance) {
                        window.unityInstance.SendMessage(
                            'PluginRuntime',
                            'HandlePaymentsGetCatalogSuccess',
                            JSON.stringify(catalog)
                        );
                    }
                })
                .catch(error => {
                    console.error('[PLAYGAMMA_ADAPTER] Get catalog error:', error);
                    if (window.unityInstance) {
                        window.unityInstance.SendMessage(
                            'PluginRuntime',
                            'HandlePaymentsGetCatalogError',
                            error.message || String(error)
                        );
                    }
                });
        },

        PaymentsGetPurchases: function() {
            console.log('[PLAYGAMMA_ADAPTER] Getting purchases');
            
            if (!window.bridge || !window.bridge.payments) {
                if (window.unityInstance) {
                    window.unityInstance.SendMessage('PluginRuntime', 'HandlePaymentsGetPurchasesError', 'Payments not initialized');
                }
                return;
            }

            window.bridge.payments.getPurchases()
                .then(purchases => {
                    const result = purchases.map(purchase => ({
                        productID: purchase.id,
                        purchaseToken: purchase.id,
                        developerPayload: '',
                        signature: ''
                    }));

                    if (window.unityInstance) {
                        window.unityInstance.SendMessage(
                            'PluginRuntime',
                            'HandlePaymentsGetPurchasesSuccess',
                            JSON.stringify(result)
                        );
                    }
                })
                .catch(error => {
                    console.error('[PLAYGAMMA_ADAPTER] Get purchases error:', error);
                    if (window.unityInstance) {
                        window.unityInstance.SendMessage(
                            'PluginRuntime',
                            'HandlePaymentsGetPurchasesError',
                            error.message || String(error)
                        );
                    }
                });
        },

        PaymentsPurchase: function(productId, developerPayload) {
            console.log('[PLAYGAMMA_ADAPTER] Purchasing product:', productId);
            
            if (!window.bridge || !window.bridge.payments) {
                if (window.unityInstance) {
                    window.unityInstance.SendMessage('PluginRuntime', 'HandlePaymentsPurchaseError', 'Payments not initialized');
                }
                return;
            }

            const options = { id: productId };
            if (developerPayload) {
                options.developerPayload = developerPayload;
            }

            window.bridge.payments.purchase(productId)
                .then(purchase => {
                    const result = {
                        productID: purchase.id,
                        purchaseToken: purchase.id,
                        developerPayload: developerPayload || '',
                        signature: ''
                    };

                    if (window.unityInstance) {
                        window.unityInstance.SendMessage(
                            'PluginRuntime',
                            'HandlePaymentsPurchaseSuccess',
                            JSON.stringify(result)
                        );
                    }
                })
                .catch(error => {
                    console.error('[PLAYGAMMA_ADAPTER] Purchase error:', error);
                    if (window.unityInstance) {
                        window.unityInstance.SendMessage(
                            'PluginRuntime',
                            'HandlePaymentsPurchaseError',
                            error.message || String(error)
                        );
                    }
                });
        },

        PaymentsConsume: function(purchaseToken) {
            console.log('[PLAYGAMMA_ADAPTER] Consuming purchase:', purchaseToken);
            
            if (!window.bridge || !window.bridge.payments) {
                if (window.unityInstance) {
                    window.unityInstance.SendMessage('PluginRuntime', 'HandlePaymentsConsumeError', 'Payments not initialized');
                }
                return;
            }

            window.bridge.payments.consumePurchase(purchaseToken)
                .then(() => {
                    if (window.unityInstance) {
                        window.unityInstance.SendMessage(
                            'PluginRuntime',
                            'HandlePaymentsConsumeSuccess',
                            purchaseToken
                        );
                    }
                })
                .catch(error => {
                    console.error('[PLAYGAMMA_ADAPTER] Consume error:', error);
                    if (window.unityInstance) {
                        window.unityInstance.SendMessage(
                            'PluginRuntime',
                            'HandlePaymentsConsumeError',
                            error.message || String(error)
                        );
                    }
                });
        },

        // Platform Navigation methods
        GoToGame: function(gameId) {
            console.log('[PLAYGAMMA_ADAPTER] Navigating to game:', gameId);
            
            if (!window.bridge || !window.bridge.platform) {
                if (window.unityInstance) {
                    window.unityInstance.SendMessage('PluginRuntime', 'HandleNavigateError', 'SDK not initialized');
                }
                return;
            }

            if (!window.bridge.platform.isGetGameByIdSupported) {
                console.log('[PLAYGAMMA_ADAPTER] GetGameById not supported');
                if (window.unityInstance) {
                    window.unityInstance.SendMessage('PluginRuntime', 'HandleNavigateError', 'Navigation not supported');
                }
                return;
            }

            const options = { gameId: gameId };
            
            window.bridge.platform.getGameById(options)
                .then(game => {
                    if (game && game.url) {
                        window.location.href = game.url;
                        if (window.unityInstance) {
                            window.unityInstance.SendMessage('PluginRuntime', 'HandleNavigateSuccess', '');
                        }
                    } else {
                        if (window.unityInstance) {
                            window.unityInstance.SendMessage('PluginRuntime', 'HandleNavigateError', 'Game not found');
                        }
                    }
                })
                .catch(error => {
                    console.error('[PLAYGAMMA_ADAPTER] Navigation error:', error);
                    if (window.unityInstance) {
                        window.unityInstance.SendMessage(
                            'PluginRuntime',
                            'HandleNavigateError',
                            error.message || String(error)
                        );
                    }
                });
        },

        GetAllGames: function() {
            console.log('[PLAYGAMMA_ADAPTER] Getting all games');
            
            if (!window.bridge || !window.bridge.platform) {
                if (window.unityInstance) {
                    window.unityInstance.SendMessage('PluginRuntime', 'HandleGetAllGamesError', 'SDK not initialized');
                }
                return;
            }

            if (!window.bridge.platform.isGetAllGamesSupported) {
                console.log('[PLAYGAMMA_ADAPTER] GetAllGames not supported');
                if (window.unityInstance) {
                    window.unityInstance.SendMessage('PluginRuntime', 'HandleGetAllGamesError', 'GetAllGames not supported');
                }
                return;
            }

            window.bridge.platform.getAllGames()
                .then(games => {
                    if (window.unityInstance) {
                        window.unityInstance.SendMessage(
                            'PluginRuntime',
                            'HandleGetAllGamesSuccess',
                            JSON.stringify(games)
                        );
                    }
                })
                .catch(error => {
                    console.error('[PLAYGAMMA_ADAPTER] GetAllGames error:', error);
                    if (window.unityInstance) {
                        window.unityInstance.SendMessage(
                            'PluginRuntime',
                            'HandleGetAllGamesError',
                            error.message || String(error)
                        );
                    }
                });
        },

        // Storage management methods
        IsStorageSupported: function(storageType) {
            console.log('[PLAYGAMMA_ADAPTER] Checking storage support:', storageType);
            
            if (!window.bridge || !window.bridge.storage) {
                if (window.unityInstance) {
                    window.unityInstance.SendMessage('PluginRuntime', 'HandleIsStorageSupportedError', 'SDK not initialized');
                }
                return;
            }

            try {
                const supported = window.bridge.storage.isSupported(storageType);
                if (window.unityInstance) {
                    window.unityInstance.SendMessage(
                        'PluginRuntime',
                        'HandleIsStorageSupportedSuccess',
                        supported ? 'true' : 'false'
                    );
                }
            } catch (error) {
                if (window.unityInstance) {
                    window.unityInstance.SendMessage(
                        'PluginRuntime',
                        'HandleIsStorageSupportedError',
                        error.message || String(error)
                    );
                }
            }
        },

        IsStorageAvailable: function(storageType) {
            console.log('[PLAYGAMMA_ADAPTER] Checking storage availability:', storageType);
            
            if (!window.bridge || !window.bridge.storage) {
                if (window.unityInstance) {
                    window.unityInstance.SendMessage('PluginRuntime', 'HandleIsStorageAvailableError', 'SDK not initialized');
                }
                return;
            }

            try {
                const available = window.bridge.storage.isAvailable(storageType);
                if (window.unityInstance) {
                    window.unityInstance.SendMessage(
                        'PluginRuntime',
                        'HandleIsStorageAvailableSuccess',
                        available ? 'true' : 'false'
                    );
                }
            } catch (error) {
                if (window.unityInstance) {
                    window.unityInstance.SendMessage(
                        'PluginRuntime',
                        'HandleIsStorageAvailableError',
                        error.message || String(error)
                    );
                }
            }
        },

        GetDefaultStorageType: function() {
            console.log('[PLAYGAMMA_ADAPTER] Getting default storage type');
            
            if (!window.bridge || !window.bridge.storage) {
                if (window.unityInstance) {
                    window.unityInstance.SendMessage('PluginRuntime', 'HandleGetDefaultStorageTypeError', 'SDK not initialized');
                }
                return;
            }

            try {
                const storageType = window.bridge.storage.defaultType || 'local_storage';
                if (window.unityInstance) {
                    window.unityInstance.SendMessage('PluginRuntime', 'HandleGetDefaultStorageTypeSuccess', storageType);
                }
            } catch (error) {
                if (window.unityInstance) {
                    window.unityInstance.SendMessage(
                        'PluginRuntime',
                        'HandleGetDefaultStorageTypeError',
                        error.message || String(error)
                    );
                }
            }
        },

        // Unsupported methods
        IsMetaverseSupported: function() {
            if (window.unityInstance) {
                window.unityInstance.SendMessage('PluginRuntime', 'HandleIsMetaverseSupportedSuccess', 'false');
            }
        },

        GetMetaversePlayerData: function() {
            console.log('[PLAYGAMMA_ADAPTER] GetMetaversePlayerData not supported');
            if (window.unityInstance) {
                window.unityInstance.SendMessage('PluginRuntime', 'HandleGetMetaverseDataError', 'Not supported by PlayGamma');
            }
        },

        SetMetaversePlayerData: function() {
            console.log('[PLAYGAMMA_ADAPTER] SetMetaversePlayerData not supported');
            if (window.unityInstance) {
                window.unityInstance.SendMessage('PluginRuntime', 'HandleSetMetaverseDataError', 'Not supported by PlayGamma');
            }
        },

        GetCombinedPlayerData: function() {
            console.log('[PLAYGAMMA_ADAPTER] GetCombinedPlayerData not supported');
            if (window.unityInstance) {
                window.unityInstance.SendMessage('PluginRuntime', 'HandleGetCombinedDataError', 'Not supported by PlayGamma');
            }
        },

        SetCombinedPlayerData: function() {
            console.log('[PLAYGAMMA_ADAPTER] SetCombinedPlayerData not supported');
            if (window.unityInstance) {
                window.unityInstance.SendMessage('PluginRuntime', 'HandleSetCombinedDataError', 'Not supported by PlayGamma');
            }
        }
    };

    console.log('[PLAYGAMMA_ADAPTER] PlayGamma adapter loaded successfully');
})();